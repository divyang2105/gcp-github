name: Build & Deploy to Cloud Run with GAR

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Select environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - test

permissions:
  contents: read
  id-token: write
    
jobs:
  build:
    name: Build and push image
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.set-image.outputs.image }}
    env:
      IMAGE_TAG: ${{ github.sha }}
      # REGIONS_MAP: '{"dev":["us-central1","us-east1"],"test":["us-central1","us-east1"]}'
    strategy:
      matrix:
        environment: [ "${{ github.event.inputs.environment || 'dev' }}" ]
        region: [us-central1, us-east1]
    environment:
      name: ${{ matrix.environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Login to JFrog (for dependency download)
      - uses: jfrog/setup-jfrog-cli@v4
        env:
          JF_URL: https://krogertechnology.jfrog.io
          JF_USER: ${{ secrets.ART_USER }}
          JF_PASSWORD: ${{ secrets.ART_TOKEN }}
      # - name: Login to JFrog
      #   run: |
      #     echo ${{ secrets.ART_TOKEN }} | docker login -u ${{ secrets.ART_USER }} krogertechnology.jfrog.io --password-stdin    

      # Authenticate to Google Artifact Registry (for image push)
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets[ format('GCP_SA_KEY_{0}', matrix.environment) ] }}

      # Configure Docker for GAR
      - name: Configure Docker for Google Artifact Registry
        run: |
          gcloud auth configure-docker ${{ matrix.region }}-docker.pkg.dev

      # Build with JFrog credentials as build args
      - name: Build and Push to Google Artifact Registry
        run: |
          IMAGE_URI="${{ matrix.region }}}-docker.pkg.dev/${{ vars.GCP_PROJECT }}/${{ vars.ARTIFACT_REGISTRY_REPOSITORY }}/${{ vars.IMAGE_NAME }}"
          docker build \
            --build-arg ART_USER=${{ secrets.ART_USER }} \
            --build-arg ART_TOKEN=${{ secrets.ART_TOKEN }} \
            -t ${IMAGE_URI}:${{ github.sha }} .
          docker push ${IMAGE_URI}:${{ github.sha }}
          docker tag ${IMAGE_URI}:${{ github.sha }} ${IMAGE_URI}:latest
          docker push ${IMAGE_URI}:latest

      - name: Set image output
        id: set-image
        run: |
          IMAGE_URI="${{ vars.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT }}/${{ vars.ARTIFACT_REGISTRY_REPOSITORY }}/${{ vars.IMAGE_NAME }}:${{ github.sha }}"
          echo "Final image URI: $IMAGE_URI"
          echo "image=${IMAGE_URI}" >> $GITHUB_OUTPUT
  # deploy:
  #   name: Deploy to ${{ matrix.environment }}
  #   needs: build
  #   runs-on: ubuntu-latest
  #   if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
  #   strategy:
  #     matrix:
  #       environment: [ "${{ github.event.inputs.environment || 'dev' }}" ]
  #   environment:
  #     name: ${{ matrix.environment }}
    
  #   # if: |
  #   #   (github.event_name == 'push' && github.ref == 'refs/heads/develop' && matrix.environment == 'dev') ||
  #   #   (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == matrix.environment)

  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4

  #     - name: Debug - Check environment variables
  #       run: |
  #         echo "Environment: ${{ matrix.environment }}"
  #         echo "GCP_PROJECT: ${{ vars.GCP_PROJECT }}"
  #         echo "Image: ${{ needs.build.outputs.image }}"
  #     - name: Authenticate to Google Cloud
  #       uses: google-github-actions/auth@v3
  #       with:
  #         credentials_json: ${{ secrets.GCP_SA_KEY }}

  #     - name: Setup gcloud
  #       uses: google-github-actions/setup-gcloud@v3
  #       with:
  #         project_id: ${{ vars.GCP_PROJECT }}

  #     - name: Deploy to Cloud Run
  #       run: |
  #         gcloud run deploy cr-app \
  #           --image="${{ needs.build.outputs.image }}" \
  #           --region="${{ vars.GCP_REGION }}" \
  #           --platform=managed \
  #           --memory=2Gi \
  #           --cpu=2 \
  #           --port=8000 \
  #           --service-account=${{ vars.APP_RUNTIME_SA }}
  #     # - name: Deploy to Cloud Run
  #     #   run: |
  #     #     gcloud run deploy cr-app \
  #     #       --image="${{ vars.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT }}/${{ vars.ARTIFACT_REGISTRY_REPOSITORY }}/${{ vars.IMAGE_NAME }}:latest" \
  #     #       --region="${{ vars.GCP_REGION }}" \
  #     #       --platform=managed \
  #     #       --allow-unauthenticated \
  #     #       --memory=2Gi \
  #     #       --cpu=2 \
  #     #       --port=8000 \
  #     #       --service-account=${{ vars.APP_RUNTIME_SA }}
            
  #     - name: Deployment Summary
  #       run: |
  #         echo "âœ… Successfully deployed to ${{ matrix.environment }}"
  #         echo "Image: ${{ needs.build.outputs.image }}"
  #         echo "Region: ${{ vars.GCP_REGION }}"
  #         echo "Service:cr-app"
